# 観点レビュー: F-009 予約確認

## 生成情報

- 生成日時: 2026-02-23
- 入力ソース: 04_テストケース.md, 01_機能詳細.md
- 参照カタログ: テスト観点カタログ v1.6（TIS株式会社, CC BY-SA 4.0）
- アプリ種別: web
- 対象機能: F-009 予約確認
- 総観点数: 30件（対象: 27件 / 対象外: 3件）
- 信号分布: 🟢 16件 / 🟡 8件 / 🔴 3件

---

## カバレッジサマリー

| セクション | 対象観点数 | 🟢 カバー済 | 🟡 未カバー推奨 | 🔴 要確認 | カバー率 |
|-----------|-----------|------------|----------------|----------|---------|
| バリデーション（VAL） | 2 | 2 | 0 | 0 | 100% |
| ウェブアプリケーション（WEB） | 11 | 9 | 2 | 0 | 82% |
| セキュリティ共通（SEC-C） | 5 | 2 | 2 | 1 | 40% |
| セキュリティウェブ（SEC-W） | 4 | 0 | 3 | 1 | 0% |
| ユーザビリティ（USA） | 5 | 3 | 1 | 1 | 60% |
| **合計** | **27** | **16** | **8** | **3** | **59%** |

※ 対象外3件（VAL-001, VAL-004, VAL-005）は入力フォームなしのため除外。カバー率は対象観点数で算出。

---

## 🟢 カバー済み観点

| # | 観点ID | 観点名 | 対応テストケース | カテゴリ |
|---|--------|--------|----------------|---------|
| 1 | VP-VAL-010 | 整合性チェック（複数フィールド間の整合） | TC-009-04〜11（合計金額計算の正確性） | バリデーション |
| 2 | VP-VAL-012 | 存在チェック（参照データの存在確認） | TC-009-28〜29（sessionStorage/Cookie不在時の制御） | バリデーション |
| 3 | VP-WEB-001 | ページタイトル表示 | TC-009-01 | ウェブアプリ |
| 4 | VP-WEB-002 | 初期表示・画面描画 | TC-009-02, TC-009-03 | ウェブアプリ |
| 5 | VP-WEB-003 | 表示データの正確性 | TC-009-12〜21（各フィールドの表示確認） | ウェブアプリ |
| 6 | VP-WEB-004 | 不正アクセス時リダイレクト | TC-009-28, TC-009-29 | ウェブアプリ |
| 7 | VP-WEB-005 | URL直接入力時の制御 | TC-009-28（Cookie不在で直接アクセス→リダイレクト） | ウェブアプリ |
| 8 | VP-WEB-006 | ブラウザリロード時挙動 | TC-009-30（リロードでリダイレクト） | ウェブアプリ |
| 9 | VP-WEB-007 | Cookie / sessionStorage 管理 | TC-009-31, TC-009-32（ページ表示後の削除確認） | ウェブアプリ |
| 10 | VP-WEB-008 | モーダル/ダイアログ表示・操作 | TC-009-23〜27（表示・閉じる・staticバックドロップ） | ウェブアプリ |
| 11 | VP-WEB-009 | 動的コンテンツ計算（合計金額） | TC-009-04〜11（平日・週末・オプション計算） | ウェブアプリ |
| 12 | VP-SEC-C-001 | 認証・認可（不正アクセス防止） | TC-009-28, TC-009-29（セッション検証なしで表示不可） | セキュリティ共通 |
| 13 | VP-SEC-C-002 | 機密データ保護（使用後クリーンアップ） | TC-009-31, TC-009-32（予約データの即時削除） | セキュリティ共通 |
| 14 | VP-USA-001 | 操作完了フィードバック | TC-009-24（モーダルタイトル「予約を完了しました」） | ユーザビリティ |
| 15 | VP-USA-002 | 操作性（ボタンの視認性・有効状態） | TC-009-22（「この内容で予約する」ボタン常時有効） | ユーザビリティ |
| 16 | VP-USA-003 | 視覚的フィードバック（アニメーション） | TC-009-23（モーダルのフェードアニメーション） | ユーザビリティ |

---

## 🟡 未カバー推奨観点

| # | 観点ID | 観点名 | 推奨理由 | カテゴリ |
|---|--------|--------|---------|---------|
| 1 | VP-WEB-010 | ブラウザ戻るボタンの挙動 | confirm.htmlは`history.replaceState`でURL書き換えているため、戻るボタンが予期しない動作をする可能性がある | ウェブアプリ |
| 2 | VP-WEB-011 | ブラウザ互換性 | `window.close()` の挙動がブラウザによって異なる（Chrome/Firefox/Safari/Edge）ため、モーダルクローズ後の動作検証が必要 | ウェブアプリ |
| 3 | VP-SEC-C-003 | エラー情報の非開示 | sessionStorage/Cookie不在時のリダイレクトで、エラー詳細がURLパラメータやコンソールに漏洩していないか確認が必要 | セキュリティ共通 |
| 4 | VP-SEC-C-004 | セキュアな値の生成 | transactionIDがランダム10桁数字で生成されるが、予測可能性・衝突可能性の検証がない | セキュリティ共通 |
| 5 | VP-SEC-W-001 | XSS対策（表示データのエスケープ） | sessionStorageから読み込んだ`username`・`comment`等をDOM表示する際、HTMLエスケープが適切に行われているか確認が必要 | セキュリティウェブ |
| 6 | VP-SEC-W-002 | CSRF対策 | confirm.htmlはサーバーリクエストなしのクライアントサイドのみだが、`transaction` Cookie の利用フローにCSRFリスクがないか確認が必要 | セキュリティウェブ |
| 7 | VP-SEC-W-004 | オープンリダイレクト | リダイレクト先URLを`location.pathname`から構築しているが、悪意あるパスによってリダイレクト先が操作される可能性がないか確認が必要 | セキュリティウェブ |
| 8 | VP-USA-004 | エラー時のユーザーフィードバック | 直接アクセス時にユーザーへの説明なく突然トップページにリダイレクトされるため、不正アクセス時の案内メッセージの必要性を確認 | ユーザビリティ |

---

## 🔴 要確認観点

| # | 観点ID | 観点名 | 確認内容 | カテゴリ |
|---|--------|--------|---------|---------|
| 1 | VP-SEC-C-005 | ログ・監査（重要操作の記録） | 「予約確定」操作のサーバーサイドログが存在するか確認が必要。デモサイトのためサーバーサイド処理なし（適用可否の判断が必要） | セキュリティ共通 |
| 2 | VP-SEC-W-003 | クリックジャッキング対策 | X-Frame-Optionsヘッダーまたはframe-ancestorsが設定されているか。デモサイトのため優先度は低いが適用可否を確認 | セキュリティウェブ |
| 3 | VP-USA-005 | アクセシビリティ（キーボード操作・スクリーンリーダー） | モーダルの`role="dialog"`・`tabindex="-1"`は設定済みだが、Escキーでモーダルが閉じるか（static backdropのため意図的に無効化？）、キーボードフォーカス管理が適切かの確認が必要 | ユーザビリティ |

---

## 補完テストケース案

🟡項目に対する補完テストケース案を以下に示します。

---

### STC-009-01: ブラウザ戻るボタンで予約フォームに戻れないこと

| 項目 | 内容 |
|------|------|
| テストID | STC-009-01 |
| 対象機能 | F-009: 予約確認 |
| 対応観点 | VP-WEB-010 |
| テスト種別 | 正常系 |
| 信号 | 🟡 |

**Given（前提条件）:**

- reserve.htmlからconfirm.htmlに遷移した状態（`history.replaceState`により履歴が書き換えられている）

**When（実行条件）:**

1. ブラウザの「戻る」ボタンをクリックする

**Then（期待結果）:**

- [ ] confirm.htmlにとどまらず、reserve.htmlへ遷移するか、あるいはセッションデータ削除済みのためリダイレクトが発生すること
- [ ] 予約データが二重送信される状態にならないこと

**根拠:** テスト観点カタログ VP-WEB-010 に基づく補完

---

### STC-009-02: 複数ブラウザでのモーダルクローズ後 window.close() 動作確認

| 項目 | 内容 |
|------|------|
| テストID | STC-009-02 |
| 対象機能 | F-009: 予約確認 |
| 対応観点 | VP-WEB-011 |
| テスト種別 | 正常系 |
| 信号 | 🟡 |

**Given（前提条件）:**

- Chrome / Firefox / Safari / Edge 各ブラウザで confirm.html を表示した状態

**When（実行条件）:**

1. 「この内容で予約する」ボタンをクリックしてモーダルを表示する
2. 「閉じる」ボタンをクリックしてモーダルを閉じる

**Then（期待結果）:**

- [ ] `window.close()` が実行されること
- [ ] スクリプトから開いたタブ/ウィンドウの場合、タブが閉じること
- [ ] 直接URLアクセスのタブでは `window.close()` がブロックされ、空のconfirm.htmlが表示されること（エラーにならないこと）

**根拠:** テスト観点カタログ VP-WEB-011 に基づく補完

---

### STC-009-03: リダイレクト時にエラー詳細が漏洩しないこと

| 項目 | 内容 |
|------|------|
| テストID | STC-009-03 |
| 対象機能 | F-009: 予約確認 |
| 対応観点 | VP-SEC-C-003 |
| テスト種別 | 異常系 |
| 信号 | 🟡 |

**Given（前提条件）:**

- `transaction` Cookie が存在しない状態でconfirm.htmlにアクセスする

**When（実行条件）:**

1. /ja/confirm.html に直接アクセスする
2. ブラウザの開発ツール → ネットワーク、コンソール、URLを確認する

**Then（期待結果）:**

- [ ] リダイレクト先URLにエラーメッセージやセッションキーが含まれないこと
- [ ] ブラウザコンソールにスタックトレースやセンシティブ情報が出力されないこと
- [ ] リダイレクトが /ja/index.html であること（意図しないパスへのリダイレクトでないこと）

**根拠:** テスト観点カタログ VP-SEC-C-003 に基づく補完

---

### STC-009-04: transactionIDの予測可能性・衝突可能性確認

| 項目 | 内容 |
|------|------|
| テストID | STC-009-04 |
| 対象機能 | F-009: 予約確認 |
| 対応観点 | VP-SEC-C-004 |
| テスト種別 | 正常系 |
| 信号 | 🟡 |

**Given（前提条件）:**

- reserve.htmlで複数回予約フォームを送信できる状態

**When（実行条件）:**

1. reserve.htmlで複数回（10回以上）フォーム送信操作を行い、各回の transaction Cookie 値を記録する

**Then（期待結果）:**

- [ ] 各回で異なる10桁数字が生成されること（連番でないこと）
- [ ] 同一セッション内での衝突（同値の再生成）が発生しないこと

**根拠:** テスト観点カタログ VP-SEC-C-004 に基づく補完

---

### STC-009-05: XSS: sessionStorageデータのDOM表示時エスケープ確認

| 項目 | 内容 |
|------|------|
| テストID | STC-009-05 |
| 対象機能 | F-009: 予約確認 |
| 対応観点 | VP-SEC-W-001 |
| テスト種別 | 異常系 |
| 信号 | 🟡 |

**Given（前提条件）:**

- reserve.htmlの氏名フィールドにXSS試験文字列を入力して送信する
- 例: 氏名 = `<script>alert('xss')</script>` または `"><img src=x onerror=alert('xss')>`

**When（実行条件）:**

1. 上記の氏名でフォームを送信し、confirm.htmlに遷移する
2. #username の表示内容を確認する

**Then（期待結果）:**

- [ ] スクリプトが実行されないこと（アラートが表示されないこと）
- [ ] XSS試験文字列が文字列としてそのまま表示されること（エスケープされていること）

**根拠:** テスト観点カタログ VP-SEC-W-001 に基づく補完

---

### STC-009-06: ご要望フィールドのXSSエスケープ確認

| 項目 | 内容 |
|------|------|
| テストID | STC-009-06 |
| 対象機能 | F-009: 予約確認 |
| 対応観点 | VP-SEC-W-001 |
| テスト種別 | 異常系 |
| 信号 | 🟡 |

**Given（前提条件）:**

- reserve.htmlのご要望フィールドにXSS試験文字列を入力して送信する
- 例: ご要望 = `<script>document.cookie='stolen='+document.cookie</script>`

**When（実行条件）:**

1. 上記のご要望でフォームを送信し、confirm.htmlに遷移する
2. pre#comment の表示内容を確認する

**Then（期待結果）:**

- [ ] スクリプトが実行されないこと
- [ ] `<pre>` タグの内容としてHTMLエスケープされて表示されること

**根拠:** テスト観点カタログ VP-SEC-W-001 に基づく補完（STC-009-05と対）

---

### STC-009-07: オープンリダイレクト: 不正なパスによるリダイレクト先操作の確認

| 項目 | 内容 |
|------|------|
| テストID | STC-009-07 |
| 対象機能 | F-009: 予約確認 |
| 対応観点 | VP-SEC-W-004 |
| テスト種別 | 異常系 |
| 信号 | 🟡 |

**Given（前提条件）:**

- `transaction` Cookie が存在しない状態

**When（実行条件）:**

1. `/ja/../confirm.html` など、パストラバーサルを含むURLでアクセスする
2. リダイレクト先URLを確認する

**Then（期待結果）:**

- [ ] リダイレクト先が意図しない外部URLや任意のパスにならないこと
- [ ] リダイレクト先が `/ja/index.html` （または相当のトップページ）であること

**根拠:** テスト観点カタログ VP-SEC-W-004 に基づく補完

---

### STC-009-08: 直接アクセス時にユーザーに適切なフィードバックが提供されること

| 項目 | 内容 |
|------|------|
| テストID | STC-009-08 |
| 対象機能 | F-009: 予約確認 |
| 対応観点 | VP-USA-004 |
| テスト種別 | 正常系 |
| 信号 | 🟡 |

**Given（前提条件）:**

- ブラウザで /ja/confirm.html を直接ブックマークからアクセスした状態（予約データなし）

**When（実行条件）:**

1. /ja/confirm.html に直接アクセスする
2. 遷移後の画面を確認する

**Then（期待結果）:**

- [ ] トップページ（/ja/index.html）にリダイレクトされること
- [ ] 理想的には：「予約セッションが見つかりませんでした。トップページからやり直してください」等の案内がある（または当該サイトの設計として無案内リダイレクトが仕様であることを確認する）

**根拠:** テスト観点カタログ VP-USA-004 に基づく補完

---

## 優先対応一覧

| # | 観点ID | 観点名 | 対応方針 | 信号 |
|---|--------|--------|---------|------|
| 1 | VP-SEC-W-001 | XSS対策 | 補完テストケース案あり（STC-009-05, STC-009-06） | 🟡 |
| 2 | VP-WEB-011 | ブラウザ互換性 | 補完テストケース案あり（STC-009-02） | 🟡 |
| 3 | VP-SEC-C-003 | エラー情報非開示 | 補完テストケース案あり（STC-009-03） | 🟡 |
| 4 | VP-WEB-010 | ブラウザ戻るボタン | 補完テストケース案あり（STC-009-01） | 🟡 |
| 5 | VP-SEC-W-004 | オープンリダイレクト | 補完テストケース案あり（STC-009-07） | 🟡 |
| 6 | VP-SEC-C-004 | セキュアトークン生成 | 補完テストケース案あり（STC-009-04） | 🟡 |
| 7 | VP-SEC-W-002 | CSRF対策 | 確認・補完テストケース案あり（STC-009-06参照） | 🟡 |
| 8 | VP-USA-004 | エラー時フィードバック | 補完テストケース案あり（STC-009-08） | 🟡 |
| 9 | VP-USA-005 | アクセシビリティ | ステークホルダー確認（Escキー動作・フォーカス管理） | 🔴 |
| 10 | VP-SEC-W-003 | クリックジャッキング | ステークホルダー確認（デモサイトの適用可否） | 🔴 |
| 11 | VP-SEC-C-005 | ログ・監査 | ステークホルダー確認（デモサイトのためサーバーサイドなし） | 🔴 |

---

## 参照カタログ情報

- **原典**: テスト観点カタログ v1.6
- **著作者**: TIS株式会社
- **ライセンス**: CC BY-SA 4.0 (Creative Commons Attribution-ShareAlike 4.0 International)
- **抽出範囲**: ブラックボックステスト関連項目（5セクション）
- **適用セクション**: バリデーション（VAL）/ ウェブアプリケーション（WEB）/ セキュリティ共通（SEC-C）/ セキュリティウェブ（SEC-W）/ ユーザビリティ（USA）

---

## 次のステップ

### 補完テストケースの反映

🟡項目の補完テストケース案を既存のテストケースに反映するには:

1. **手動追記**: `04_テストケース.md` に STC-009-01〜08 をコピーして追記
2. **再生成**: 動作仕様（`02_動作仕様.md`）に観点を追加した上で、`/origami:generate-cases` を再実行

### 確認事項

- 🔴項目（アクセシビリティ・クリックジャッキング・ログ監査）についてステークホルダーに確認
- XSS観点（STC-009-05, 06）の補完テストケース案を優先的に実施推奨
- ブラウザ互換性（STC-009-02）: window.close()はブラウザポリシーに依存するため、対応ブラウザを確定してからテスト
- カバレッジ: 全体59%（標準目標70%に対してやや不足。SEC-Wの強化推奨）
