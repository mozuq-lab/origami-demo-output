# F-009 予約確認 機能詳細

## 基本情報

| 項目 | 内容 |
|------|------|
| 機能ID | F-009 |
| 機能名 | 予約確認 |
| 対象URL | /ja/confirm.html |
| 依存機能 | F-008（宿泊予約入力）完了後に遷移 |

---

## 機能概要

F-008（宿泊予約入力）で入力・保存された予約データを確認画面に表示し、予約の最終確定を行う機能。

- 予約データは `sessionStorage`（キーは `transaction` Cookie の値）から取得
- ページ読み込み時にデータを即時消費（Cookie・sessionStorage を削除）
- 「この内容で予約する」ボタンでBootstrapモーダル（アニメーション付き）を表示
- モーダルクローズ後に `window.close()` を実行してタブを閉じる

---

## ページ構成

### ページタイトル

```
宿泊予約確認 | HOTEL PLANISPHERE - テスト自動化練習サイト
```
信頼性: 🟢

### ナビゲーション

- ブランドロゴ: 「Hotel Planisphere」（`href="#"` のみ、ナビゲーションリンクなし）
- 信頼性: 🟢

---

## 表示項目

### 予約サマリー

| 表示項目 | DOM要素 ID | 表示形式 | 信頼性 |
|----------|-----------|---------|--------|
| 合計金額（h3） | `total-bill` | `合計 {金額}円（税込み）` | 🟢 |
| プラン名（h4） | `plan-name` | プラン名そのまま | 🟢 |
| プラン説明（p.text-muted） | `plan-desc` | `お一人様1泊{金額}円〜、土日は25%アップ` | 🟢 |

### 詳細項目（定義リスト `<dl>`）

| ラベル（dt） | 値（dd）DOM ID | 表示形式 | 信頼性 |
|------------|--------------|---------|--------|
| 期間 | `term` | `{チェックイン年月日} 〜 {チェックアウト年月日} {泊数}泊` | 🟢 |
| 人数 | `head-count` | `{人数}名様` | 🟢 |
| 追加プラン | `plans` | 選択時: `<ul><li>プラン名</li>...</ul>` / 未選択: `なし` | 🟢 |
| お名前 | `username` | `{氏名}様` | 🟢 |
| 確認のご連絡 | `contact` | `希望しない` / `メール：{メールアドレス}` / `電話：{電話番号}` | 🟢 |
| ご要望・ご連絡事項等 | `comment`（`<pre>`） | 入力値そのまま / 未入力: `なし` | 🟢 |

---

## データフロー

### sessionStorage からのデータ読み込み

#### Cookie・sessionStorage 構造

| 項目 | 詳細 | 信頼性 |
|------|------|--------|
| Cookie名 | `transaction` | 🟢 |
| Cookie値 | ランダム生成10桁数字（sessionStorageキー） | 🟢 |
| sessionStorageキー | Cookie値（10桁数字） | 🟢 |
| sessionStorage値 | JSON文字列 | 🟢 |

#### sessionStorage 格納 JSON フィールド

| フィールド名 | 型 | 内容 | 信頼性 |
|------------|-----|------|--------|
| `roomBill` | number | 1泊1人あたり基本料金（円） | 🟢 |
| `planName` | string | プラン名 | 🟢 |
| `date` | string | チェックイン日（YYYY-MM-DD形式） | 🟢 |
| `term` | number | 宿泊数（泊） | 🟢 |
| `headCount` | number | 人数 | 🟢 |
| `breakfast` | boolean | 朝食バイキング選択有無 | 🟢 |
| `earlyCheckIn` | boolean | 昼からチェックインプラン選択有無 | 🟢 |
| `sightseeing` | boolean | お得な観光プラン選択有無 | 🟢 |
| `username` | string | 氏名 | 🟢 |
| `contact` | string | 連絡方法（`"no"` / `"email"` / `"tel"`） | 🟢 |
| `email` | string | メールアドレス（contact=emailの場合） | 🟢 |
| `tel` | string | 電話番号（contact=telの場合） | 🟢 |
| `comment` | string | ご要望・ご連絡事項（空欄時は空文字列） | 🟢 |

### データ消費タイミング

- ページ読み込み時に **即座に** Cookie と sessionStorage を削除 🟢
- リロード時はデータが存在しないためトップページへリダイレクト 🟢

---

## 合計金額計算ロジック（confirm.bundle.js）

```
合計 = 基本料金(roomBill) × 人数(headCount) × 宿泊数(term)
各日付を確認:
  土曜(day=6) または 日曜(day=0): += 基本料金 × 人数 × 0.25（週末割増）
朝食バイキング選択時: += 1,000 × 人数 × 宿泊数
昼からチェックインプラン選択時: += 1,000 × 人数
お得な観光プラン選択時: += 1,000 × 人数
```

| 計算項目 | 計算式 | 信頼性 |
|---------|--------|--------|
| 基本料金 | `roomBill × headCount × term` | 🟢 |
| 週末割増 | 土日各1日につき `roomBill × headCount × 0.25` を加算 | 🟢 |
| 朝食バイキング | `1,000 × headCount × term` | 🟢 |
| 昼からチェックインプラン | `1,000 × headCount`（宿泊数不問・1回分） | 🟡 reserve.htmlの動作仕様では「1,000円×人数×宿泊数」と記載しており、confirm.htmlとの整合性要確認 |
| お得な観光プラン | `1,000 × headCount`（宿泊数不問・1回分） | 🟡 同上 |
| 表示形式 | `合計 {数値}円（税込み）` | 🟢 |

---

## 「この内容で予約する」ボタン

| 項目 | 内容 | 信頼性 |
|------|------|--------|
| ボタンテキスト | この内容で予約する | 🟢 |
| 動作 | Bootstrapモーダル（#success-modal）を表示 | 🟢 |
| サーバー送信 | なし（クライアントサイドのみ） | 🟢 |
| ボタン無効化 | なし（常にクリック可能） | 🟢 |

---

## モーダル（予約完了ダイアログ）

| 項目 | 内容 | 信頼性 |
|------|------|--------|
| モーダルID | `success-modal` | 🟢 |
| Bootstrapクラス | `modal fade`（フェードアニメーション） | 🟢 |
| バックドロップ | `data-backdrop="static"`（モーダル外クリックで閉じない） | 🟢 |
| タイトル | 予約を完了しました | 🟢 |
| 本文 | ご来館、心よりお待ちしております。 | 🟢 |
| 閉じるボタン（ヘッダー×） | `data-dismiss="modal"` | 🟢 |
| 閉じるボタン（フッター） | `閉じる`（btn-success/緑色）/ `data-dismiss="modal"` | 🟢 |

### モーダルクローズ後の動作

- `hidden.bs.modal` イベントで `window.close()` を実行 🟢
- ブラウザがタブを閉じた場合: タブが閉じる 🟢
- ブラウザが `window.close()` をブロックした場合: 空の確認画面に留まる 🟡

---

## 直接アクセス時の挙動（エラーハンドリング）

| 条件 | 挙動 | 信頼性 |
|------|------|--------|
| `transaction` Cookieが存在しない | `/ja/index.html` へリダイレクト | 🟢 |
| sessionStorageにデータが存在しない | `/ja/index.html` へリダイレクト | 🟢 |
| ページリロード時 | 上記と同様にリダイレクト（データは初回ロード時に削除済み） | 🟢 |

---

## 技術スタック

| ライブラリ | バージョン | 用途 | 信頼性 |
|----------|----------|------|--------|
| jQuery | （minified） | DOM操作・イベント | 🟢 |
| Bootstrap | （bundle含む） | モーダル・スタイル | 🟢 |
| confirm.bundle.js | カスタム | データ表示・計算・遷移制御 | 🟢 |

---

## 信号サマリー

| 信号 | 件数 | 内容 |
|------|------|------|
| 🟢 | 34 | ページ構成・表示項目・データフロー・モーダル構造・エラーハンドリング等（confirm.htmlから明示的に確認） |
| 🟡 | 3 | 昼からチェックインプラン/観光プランの計算式（宿泊数不問の可能性）、window.close()ブロック時の動作 |
| 🔴 | 0 | - |
