# F-008 宿泊予約入力 機能詳細

## 基本情報

| 項目 | 内容 |
|------|------|
| 機能ID | F-008 |
| 機能名 | 宿泊予約入力 |
| 対象ページ | reserve.html |
| 入力ソース | https://hotel-example-site.takeyaqa.dev/ja/reserve.html?plan-id=4 |

---

## 機能概要

プラン一覧ページの「このプランで予約」ボタンから新しいタブで開く予約入力フォーム。宿泊日・宿泊数・人数・オプション・連絡先情報を入力し、合計金額を動的に計算した上で確認画面へ遷移する。

---

## 画面構成

### ページタイトル

🟢 「宿泊予約 | HOTEL PLANISPHERE - テスト自動化練習サイト」

### ナビゲーション

🟢 ヘッダーに「Hotel Planisphere」ロゴリンクのみ表示（ナビゲーションメニューは存在しない）

---

## フォームフィールド仕様

### 必須入力フィールド

#### 宿泊日（date）

🟢 以下の仕様に従う:

| 項目 | 内容 |
|------|------|
| HTML要素 | `<input type="text" id="date" name="date" required>` |
| 入力方式 | jQuery UI Datepicker（カレンダーUIから選択） |
| 表示形式 | yyyy/mm/dd |
| 初期値 | 本日の翌日 |
| 入力制限 | 本日から3ヶ月以内の日付のみ選択可能 |
| エラーメッセージ | 「ご予約は3ヶ月以内の日付のみ可能です。」 |
| ヒントテキスト | 「ご予約は3ヶ月以内の日付のみ可能です。」（フォーム下に常時表示） |
| 合計金額計算 | 日付入力完了前は合計金額が「-」となる |

#### 宿泊数（term）

🟢 以下の仕様に従う:

| 項目 | 内容 |
|------|------|
| HTML要素 | `<input type="number" id="term" name="term" required>` |
| 初期値 | 1 |
| min/max | プランによって異なる（JavaScriptで動的設定） |
| 表示単位 | 〇泊 |

#### 人数（head-count）

🟢 以下の仕様に従う:

| 項目 | 内容 |
|------|------|
| HTML要素 | `<input type="number" id="head-count" name="head-count" required>` |
| 初期値 | 1 |
| min/max | プランによって異なる（JavaScriptで動的設定） |
| 表示単位 | 〇人 |

#### 氏名（username）

🟢 以下の仕様に従う:

| 項目 | 内容 |
|------|------|
| HTML要素 | `<input type="text" id="username" name="username" required>` |
| 入力制限 | なし（自由テキスト） |
| 必須 | ✓ |

#### 確認のご連絡（contact）

🟢 以下の仕様に従う:

| 項目 | 内容 |
|------|------|
| HTML要素 | `<select id="contact" name="contact" required>` |
| 必須 | ✓ |

| 選択値 | 表示テキスト | メールアドレス欄 | 電話番号欄 |
|--------|------------|----------------|----------|
| `""` | 選択してください（デフォルト） | disabled | disabled |
| `no` | 希望しない | disabled | disabled |
| `email` | メールでのご連絡 | enabled（必須） | disabled |
| `tel` | 電話でのご連絡 | disabled | enabled（必須） |

### 条件付き必須フィールド

#### メールアドレス（email）

🟢 以下の仕様に従う:

| 項目 | 内容 |
|------|------|
| HTML要素 | `<input type="email" id="email" name="email">` |
| 初期状態 | disabled（入力不可） |
| 必須条件 | 連絡方法で「メールでのご連絡」選択時のみ必須・有効化 |
| バリデーション | type="email"によるブラウザネイティブ形式チェック |

#### 電話番号（tel）

🟢 以下の仕様に従う:

| 項目 | 内容 |
|------|------|
| HTML要素 | `<input type="tel" id="tel" name="tel" pattern="[0-9]{11}">` |
| 初期状態 | disabled（入力不可） |
| 必須条件 | 連絡方法で「電話でのご連絡」選択時のみ必須・有効化 |
| バリデーション | pattern="[0-9]{11}" → 半角数字11桁 |
| ヒントテキスト | 「11桁の数字で入力してください。例：01133335555」 |

### 任意入力フィールド

#### ご要望・ご連絡事項（comment）

🟢 以下の仕様に従う:

| 項目 | 内容 |
|------|------|
| HTML要素 | `<textarea id="comment" name="comment" maxlength="140">` |
| 必須 | ✗（任意） |
| 文字数制限 | 最大140文字 |

### オプション項目（チェックボックス）

🟢 以下の3つのオプションが存在する:

| id | 表示名 | 単価 | 料金計算単位 |
|----|--------|------|------------|
| breakfast | 朝食バイキング | 1,000円 | 人数 × 宿泊数 |
| early-check-in | 昼からチェックインプラン | 1,000円 | 人数 × 宿泊数 |
| sightseeing | お得な観光プラン | 1,000円 | 人数 × 宿泊数 |

- ラベル表示: 「追加プラン お一人様各1,000円」
- 初期状態: すべて未チェック
- 必須: ✗（0個以上任意選択）

### 非表示フィールド（Hidden）

🟢 以下の情報がhiddenフィールドとして保持される:

| id | 内容 | 設定元 |
|----|------|--------|
| plan-id-hidden | プランID（例: 4） | URLクエリパラメータ plan-id |
| plan-name-hidden | プラン名（例: 素泊まり） | plan_data.jsonから取得 |
| room-bill-hidden | 基本宿泊料金（例: 5500） | plan_data.jsonから取得 |

---

## プランデータ連携仕様

### plan-idパラメータ

🟢 URLクエリパラメータ `plan-id` からプラン情報を取得し、フォームに適用する:

- plan_data.json（またはローカルデータ）から該当プランを検索
- 宿泊数・人数のmin/max属性をJavaScriptで動的設定
- プラン名・基本料金をhiddenフィールドに設定

### プラン別制約一覧

🟢 プランIDによって宿泊数・人数の範囲が異なる:

| プランID | プラン名 | 宿泊数（min-max） | 人数（min-max） | 基本料金（1人1泊） |
|---------|---------|----------------|---------------|----------------|
| 1 | プレミアムプラン | 1〜9泊 | 2〜9人 | 10,000円 |
| 2 | ディナー付きプラン | 1〜3泊 | 1〜4人 | 8,500円 |
| 3 | お得なプラン | 1〜9泊 | 1〜9人 | 6,000円 |
| 4 | 素泊まり | 1〜9泊 | 1〜2人 | 5,500円 |
| 5 | 出張ビジネスプラン | 1〜9泊 | 1〜2人 | 7,500円 |
| 6 | エステ・マッサージプラン | 1〜9泊 | 1〜6人 | 9,000円 |
| 7 | 貸し切り露天風呂プラン | 1〜3泊 | 1〜6人 | 9,000円 |
| 8 | カップル限定プラン | 1〜2泊 | 2〜2人 | 8,000円 |
| 9 | テーマパーク優待プラン | 1〜5泊 | 1〜9人 | 10,000円 |

---

## 合計金額計算仕様

### 計算式

🟢 以下の計算式で合計金額を動的計算する:

```
合計金額 = (基本宿泊料金 × 宿泊数 × 人数) + (選択オプション料金)

選択オプション料金 = 選択オプション数 × 1,000円 × 宿泊数 × 人数
```

**計算例（素泊まり, 宿泊2泊, 人数2人, 朝食+観光オプション選択）:**
```
= (5,500 × 2 × 2) + (2 × 1,000 × 2 × 2)
= 22,000 + 8,000
= 30,000円
```

### 計算条件

🟢 以下の条件が満たされた場合のみ計算を実施:

- 宿泊日が入力されている（未入力の場合は「-」を表示）
- 宿泊数が有効な範囲内にある
- 人数が有効な範囲内にある

### 計算トリガー

🟢 以下のフィールド変更時に自動再計算:

- 宿泊日（date）
- 宿泊数（term）
- 人数（head-count）
- 朝食バイキング（breakfast）チェックボックス
- 昼からチェックインプラン（early-check-in）チェックボックス
- お得な観光プラン（sightseeing）チェックボックス

### 合計金額表示

🟢 `<output role="status">` 要素に金額を表示する:

- 計算可能: 「¥XX,XXX」形式で表示
- 計算不可（宿泊日未入力等）: 「-」を表示

---

## 送信ボタン仕様

### ボタン状態制御

🟢 「予約内容を確認する」ボタンは以下の仕様で制御される:

| 状態 | 条件 |
|------|------|
| disabled（初期） | フォームが未完成の状態 |
| enabled | 全必須フィールドがバリデーションを通過した状態 |

### 送信処理フロー

🟢 送信ボタンクリック時の処理:

1. HTML5 Form Validation API（`checkValidity()`）で全フィールドを検証
2. バリデーション失敗 → 送信キャンセル、ブラウザ標準エラーメッセージを表示
3. バリデーション成功:
   a. `genTransactionId()` でトランザクションID生成（ISOタイムスタンプベース: `20260223070123456`形式）
   b. 予約データをJSON形式でsessionStorageに保存（キー: `reservation-data`）
   c. トランザクションIDをCookieに設定
   d. confirm.html へ遷移（同一タブ）

---

## 初期表示状態

🟢 ページ読み込み時の初期状態:

| フィールド | 初期値 |
|----------|--------|
| 宿泊日 | 本日の翌日 |
| 宿泊数 | 1 |
| 人数 | 1 |
| オプション（全3種） | 未チェック |
| 連絡方法 | 「選択してください」 |
| メールアドレス | disabled（入力不可） |
| 電話番号 | disabled（入力不可） |
| ご要望・ご連絡事項 | 空欄 |
| 合計金額 | 「-」 |
| 送信ボタン | disabled |

---

## データ保存仕様

🟢 送信時に sessionStorage に保存される予約データ:

- プランID、プラン名、基本料金
- 宿泊日、宿泊数、人数
- 選択オプション（朝食・昼チェックイン・観光）
- 氏名、連絡方法、メールアドレスまたは電話番号
- ご要望・ご連絡事項
- 合計金額
- トランザクションID

---

## 技術情報

| 項目 | 内容 |
|------|------|
| JavaScriptバンドル | `reserve.bundle.js`（Webpackバンドル） |
| 日付ピッカー | jQuery UI Datepicker + datepicker-ja.js（日本語化） |
| フォームバリデーション | HTML5 Form Validation API + カスタムバリデーション関数 |
| 合計金額計算 | `calcTotalBill()` 関数 |
| トランザクションID生成 | `genTransactionId()` 関数（ISOタイムスタンプ） |
| データ保存先 | sessionStorage（予約データ）、Cookie（トランザクションID） |
| 遷移先 | `/ja/confirm.html`（同一タブ） |

---

## 関連機能

| 機能 | 関係 |
|------|------|
| F-007 プラン一覧表示 | 「このプランで予約」ボタンから reserve.html?plan-id={id} に遷移 |
| F-009 予約確認 | 「予約内容を確認する」ボタンで confirm.html へ遷移 |

---

## 信号サマリー

| 信号 | 件数 | 内容 |
|------|------|------|
| 🟢 | 18 | ページタイトル、全フォームフィールド仕様、プランデータ連携、合計金額計算式、送信処理フロー、初期状態、データ保存仕様、技術情報 |
| 🟡 | 0 | - |
| 🔴 | 0 | - |
